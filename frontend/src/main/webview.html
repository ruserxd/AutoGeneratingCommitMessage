<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <title>LangChain Git Commit 系統</title>
    <style>
        body {
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            margin: 30px;
            background-color: #1e1e1e;
            color: #f1f1f1;
        }

        button {
            padding: 10px 20px;
            margin-right: 10px;
            margin-top: 10px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            background-color: #007bff;
            color: white;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .box {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #555;
            white-space: pre-wrap;
            background-color: #2a2a2a;
            color: #ffffff;
            font-size: 15px;
            border-radius: 6px;
            box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.3);
        }

        h2 {
            margin-top: 40px;
            border-bottom: 2px solid #555;
            padding-bottom: 5px;
            color: #dddddd;
        }
    </style>
</head>

<body>
    <h1>LangChain Git Commit</h1>
    <p>請點選下方按鈕來執行相關操作：</p>

    <button onclick="getGitStatus()">取得 Git Status</button>
    <button onclick="generateCommit()">產生 Commit Message</button>

    <h2>Git Status 結果</h2>
    <div id="status" class="box">尚未載入 Git 狀態。</div>

    <h2>Stage</h2>
    <div id="stage" class="box">尚無檔案</div>

    <h2>Commit Message 結果</h2>
    <div id="commit" class="box">尚未產生 commit message。</div>

    <script>
        const vscode = acquireVsCodeApi();

        // 取得 Git Status 的函式
        function getGitStatus() {
            document.getElementById("status").innerText = "讀取中，請稍候...";
            
            fetch("http://localhost:8080/getStatus")
                .then((response) => response.text())
                .then((data) => {
                    const lines = data.split("\n");
                    const path = lines
                        .map((line) => {
                            if (line.trim().endsWith(".java")) {
                                const cleanPath = line.trim().includes("->")
                                    ? line.trim().split("->")[1].trim()
                                    : line.trim();
                                return `<a href="#" onclick="showDiff('${cleanPath}')" style="display: inline;">${line.trim()} <a href="#" onclick="addToStage('${cleanPath}')" style="display: inline;">[add]</a>`;
                            } else {
                                return line;
                            }
                        })
                        .join("<br>");
                    document.getElementById("status").innerHTML = path;
                })
                .catch((error) => {
                    document.getElementById("status").innerText =
                        "發生錯誤：" + error.message;
                });


            // 這裡是用來初始化 stage 的內容
            vscode.postMessage({
                command: "initStage",
            });

            window.addEventListener('message', event => {
                const message = event.data;
                if (message.command === 'sendData') {
                    const data = message.data;
                    
                    // 先清空 stage 的內容
                    document.getElementById('stage').innerText = "尚無檔案";

                    // 按行切割
                    const lines = data.split('\n').map(line => line.trim()).filter(line => line.length > 0);

                    for (const line of lines) {
                        const stageElement = document.getElementById("stage");
                        const currentContent = stageElement.innerText.trim();                   
                        const files = Array.from(stageElement.querySelectorAll("div"))
                            .map((div) => div.dataset.path)
                            .filter((path) => path);
                        if (!files.includes(lines)) {
                            if (currentContent === "尚無檔案") {
                                stageElement.innerText = ""; // 清掉「尚無檔案」
                            }

                            const fileDiv = document.createElement("div");
                            fileDiv.dataset.path = lines; // 用 data-path 存檔案路徑（方便判斷重複）
                            fileDiv.style.marginBottom = "4px";

                            // 建立文字節點
                            const textNode = document.createTextNode(lines + " ");

                            // 建立 <a> 標籤
                            const link = document.createElement("a");
                            link.href = "#";
                            link.innerText = "[remove]";
                            link.style.textDecoration = "none";
                            link.style.marginLeft = "8px";
                            link.onclick = function (e) {
                                e.preventDefault();
                                vscode.postMessage({
                                    command: "remove",
                                    file: lines,
                                });
                                stageElement.removeChild(fileDiv); // 移除這個 div
                            };

                            // 把 filePath + <a> 都加到 div
                            fileDiv.appendChild(textNode);
                            fileDiv.appendChild(link);

                            // 把 div 加到 stageElement
                            stageElement.appendChild(fileDiv);
                        }
                    }
                }
            });

            
        }

        // 產生 commit message 的函式
        function generateCommit() {
            vscode.postMessage({
                command: "generateCommit"
            });
            document.getElementById("commit").innerText = "產生中，請稍候...";
            fetch("http://localhost:8080/getCommitMessage")
                .then((response) => response.text())
                .then((data) => {
                    document.getElementById("commit").innerText = data;
                })
                .catch((error) => {
                    document.getElementById("commit").innerText =
                        "發生錯誤：" + error.message;
                });
        }

        //將檔案移出或移入 stage 的函式
        function addToStage(filePath) {
            const stageElement = document.getElementById("stage");
            const currentContent = stageElement.innerText.trim();
            vscode.postMessage({
                command: "addStage",
                file: filePath,
            });

            const files = Array.from(stageElement.querySelectorAll("div"))
                .map((div) => div.dataset.path)
                .filter((path) => path);

            if (!files.includes(filePath)) {
                if (currentContent === "尚無檔案") {
                    stageElement.innerText = ""; // 清掉「尚無檔案」
                }

                const fileDiv = document.createElement("div");
                fileDiv.dataset.path = filePath; // 用 data-path 存檔案路徑（方便判斷重複）
                fileDiv.style.marginBottom = "4px";

                // 建立文字節點
                const textNode = document.createTextNode(filePath + " ");

                // 建立 <a> 標籤
                const link = document.createElement("a");
                link.href = "#";
                link.innerText = "[remove]";
                link.style.textDecoration = "none";
                link.style.marginLeft = "8px";
                link.onclick = function (e) {
                    e.preventDefault();
                    vscode.postMessage({
                        command: "remove",
                        file: filePath,
                    });
                    stageElement.removeChild(fileDiv); // 移除這個 div
                };

                // 把 filePath + <a> 都加到 div
                fileDiv.appendChild(textNode);
                fileDiv.appendChild(link);

                // 把 div 加到 stageElement
                stageElement.appendChild(fileDiv);
            }
            
        }


        // 顯示 diff 的函式
        function showDiff(filePath) {
            vscode.postMessage({
                command: "showDiff",
                file: filePath,
            });
        }

    </script>
</body>

</html>